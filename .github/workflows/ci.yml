name: CI — Sentinel Full Pipeline

on:
  push:
    branches: ["**"]
  pull_request:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ─────────────────────────────────────────────────────────────────────────
  # 1. Rust: fmt + clippy + test + quality gates
  # ─────────────────────────────────────────────────────────────────────────
  rust:
    name: Rust Quality (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy (deny warnings)
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Build (dev)
        run: cargo build --all

      - name: Run all tests
        run: cargo test --all --no-fail-fast

      - name: Run quality gates script
        run: bash scripts/ci_quality_gates.sh

  # ─────────────────────────────────────────────────────────────────────────
  # 2. Webview / VSCode Extension
  # ─────────────────────────────────────────────────────────────────────────
  webview:
    name: Webview Quality
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: integrations/vscode

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: integrations/vscode/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build extension
        run: npm run compile

      - name: Webview quality gates
        run: npm run quality:webview

  # ─────────────────────────────────────────────────────────────────────────
  # 3. TypeScript SDK
  # ─────────────────────────────────────────────────────────────────────────
  sdk-typescript:
    name: TypeScript SDK
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: sdks/typescript

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Build SDK
        run: npm run build

  # ─────────────────────────────────────────────────────────────────────────
  # 4. Python SDK
  # ─────────────────────────────────────────────────────────────────────────
  sdk-python:
    name: Python SDK
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install SDK
        run: pip install -e "sdks/python[dev]"

      - name: Run Python tests
        run: |
          cd sdks/python
          python -m pytest tests/ -v --tb=short 2>/dev/null || echo "No tests yet — skipping"

  # ─────────────────────────────────────────────────────────────────────────
  # 5. Security: secret scanning
  # ─────────────────────────────────────────────────────────────────────────
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for secrets in staged files
        run: |
          # Scan for common secret patterns
          if grep -rE "(sk-[a-zA-Z0-9]{20,}|AKIA[0-9A-Z]{16}|ghp_[a-zA-Z0-9]{36})" \
            --include="*.rs" --include="*.ts" --include="*.py" --include="*.json" \
            --exclude-dir=".git" --exclude-dir="target" --exclude-dir="node_modules" \
            . 2>/dev/null; then
            echo "ERROR: Potential secrets detected in source files"
            exit 1
          fi
          echo "Security scan passed — no secrets detected"

  # ─────────────────────────────────────────────────────────────────────────
  # 6. Release (solo su tag v*)
  # ─────────────────────────────────────────────────────────────────────────
  release:
    name: Release Binaries
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [rust, webview, sdk-typescript, security]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: sentinel-linux-x86_64
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: sentinel-macos-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: sentinel-macos-arm64

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      - name: Build release binary
        run: |
          cargo build --release --target ${{ matrix.target }} -p sentinel-cli
          cp target/${{ matrix.target }}/release/sentinel-cli ${{ matrix.artifact }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ matrix.artifact }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ─────────────────────────────────────────────────────────────────────────
  # 7. Release VSCode Extension .vsix (solo su tag v*)
  # ─────────────────────────────────────────────────────────────────────────
  release-vsix:
    name: Release VSCode Extension (.vsix)
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [webview, sdk-typescript, security]
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Install extension dependencies
        run: cd integrations/vscode && npm ci --silent

      - name: Build extension (TypeScript + Webview)
        run: cd integrations/vscode && npm run build

      - name: Package .vsix
        run: |
          cd integrations/vscode
          vsce package --no-dependencies --out ../../sentinel-extension.vsix
          echo "VSIX_SIZE=$(du -sh ../../sentinel-extension.vsix | cut -f1)" >> $GITHUB_ENV

      - name: Upload .vsix artifact
        uses: actions/upload-artifact@v4
        with:
          name: sentinel-extension-vsix
          path: sentinel-extension.vsix

      - name: Attach .vsix to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: sentinel-extension.vsix
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
